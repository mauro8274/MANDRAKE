<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Tracker & Strategia</title>
    <link rel="icon" href="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" type="image/png">
    <style>
        /* CSS per Stile e Responsiveness - RIPRISTINATO ORIGINALE */
        :root {
            --green-dark: #006400; 
            --green-light: #90ee90; 
            --red: #ff4500; 
            --black: #000000;
            --white: #ffffff;
            --gold: #ffd700;
            --gray-light: #f0f0f0;
            --blue-recall: #007bff; 
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--green-dark);
            color: var(--white);
            transition: background-color 0.5s;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 10px;
        }

        .header h1 {
            text-align: center;
            color: var(--gold);
            margin-bottom: 5px;
        }
        
        .header img {
            max-width: 50%; 
            max-height: 12vh; 
            height: auto;
            display: block;
            margin: 0 auto; 
            padding-top: 5px; 
            padding-bottom: 5px;
            box-sizing: border-box;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid var(--gold);
            box-sizing: border-box;
            background-color: var(--white);
            color: var(--black);
            font-size: 1.1em;
            text-align: center;
        }

        .info-box {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        #saldoRealTimeContainer {
            text-align: center;
        }
        
        #saldoRealTimeValue {
            font-size: 2em;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            padding: 5px;
            border-radius: 5px;
            background-color: var(--white);
            color: var(--red); 
        }

        #scommessaContainer {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--black);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #scommessaContainer h3 {
            margin-top: 0;
            color: var(--green-dark);
        }

        #scommessaValue {
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1.5;
            color: var(--black);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        th, td {
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 0.9em;
        }

        th {
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--gold);
            position: sticky;
            top: 0;
        }
        
        .highlighted-row {
            background-color: var(--green-light) !important;
            color: var(--black);
            font-weight: bold;
        }

        .main-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px; 
            margin-bottom: 15px; 
        }
        
        .main-buttons-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex-grow: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 0.9em;
            min-width: 100px;
        }
        
        #btnArchivia { background-color: #1e90ff; color: var(--white); }
        #btnResetSession { background-color: #dc3545; color: var(--white); }
        #btnToArchive { background-color: #ffc107; color: var(--black); }
        #btnRecallLast7 { background-color: var(--blue-recall); color: var(--white); }
        #btnToGameFromArchive { background-color: #28a745; color: var(--white); }
        #btnResetArchive { background-color: #6c757d; color: var(--white); }

        .view { display: none; }
        #gameView { display: block; }

        #archiveView {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            min-height: 100vh;
        }
        
        #archiveView table {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--black);
        }

        #cassaStoricaContainer {
            text-align: center;
            background-color: var(--gold);
            color: var(--black);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        #cassaStoricaValue {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        @media (max-width: 600px) {
            .main-buttons-row { flex-direction: column; gap: 5px; }
            .main-buttons-container button { min-width: 100%; }
        }
    </style>
</head>
<body>

    <div id="gameView" class="view container">
        <div class="header">
            <img src="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" alt="Logo">
        </div>

        <div class="info-box">
            <label for="numeroEstratto">NUOVO NUMERO ESTRATTO (0-36):</label>
            <input type="number" id="numeroEstratto" inputmode="numeric" autofocus>
            
            <label for="puntataInput">PUNTATA (Valore di 1 Fiche in â‚¬):</label>
            <input type="number" id="puntataInput" step="0.01" value="0.10">
        </div>

        <div id="saldoRealTimeContainer" class="info-box">
            <label>SALDO REAL TIME</label>
            <span id="saldoRealTimeValue">0.00â‚¬</span>
        </div>
        
        <div class="main-buttons-container">
            <div class="main-buttons-row">
                <button id="btnArchivia">Archivia Sessione</button>
                <button id="btnResetSession">Reset Sessione</button>
                <button id="btnToArchive">Archivio</button>
            </div>
            <button id="btnRecallLast7">Richiama Ultimi 7 Numeri</button>
        </div>
        
        <div class="info-box">
            <table id="dataAreaTable">
                <thead><tr><th colspan="9">ULTIMI 9 NUMERI</th></tr></thead>
                <tbody><tr id="lastNineNumbersRow"></tr></tbody>
            </table>
        </div>

        <div id="scommessaContainer">
            <h3>SCOMMESSA CONSIGLIATA</h3>
            <p id="scommessaValue">Inserisci 9 numeri per calcolare...</p>
        </div>

        <div class="info-box">
            <table id="bettingTable">
                <thead>
                    <tr><th>STEP</th><th>COLORE</th><th>LINEA</th><th>DOZZINA</th><th>TOT. BET</th><th>NETTO</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="archiveView" class="view">
        <div class="container">
            <div class="header"><h1>ðŸ“š Archivio Sessioni</h1></div>
            <div id="cassaStoricaContainer">
                <label>CASSA STORICA NETTA</label>
                <span id="cassaStoricaValue">0.00â‚¬</span>
            </div>
            <div class="main-buttons-row" style="margin: 20px 0;">
                <button id="btnToGameFromArchive">Torna al Gioco</button>
                <button id="btnResetArchive">Reset Archivio Storico</button>
            </div>
            <table id="archiveTable">
                <thead>
                    <tr><th>DATA</th><th>ORA</th><th>NETTO</th><th>INVEST.</th><th>STEP</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // === CONFIGURAZIONE E VARIABILI RIPRISTINATE ===
        const JSON_BIN_ID = '693c2d5343b1c97be9e984aa'; 
        const API_KEY = '$2a$10$ayP59Hfi7LkT35rikrQPk.p7vm9HN/Cko1Nwr2I0HrZyu0/1BVMLe'; 
        const API_URL = `https://api.jsonbin.io/v3/b/${JSON_BIN_ID}`;

        const ROULETTE_MAP = {
            'RED': [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36],
            'BLACK': [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35],
            'D1': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            'D2': [13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
            'D3': [25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36],
            'L2': [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35], 
            'L3': [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36]  
        };

        let sessionData = {
            extractedNumbers: [],
            currentStep: 0,
            betFactors: { color: '', line: '', dozen: '' },
            betHistory: [],
            saldoRealTime: 0.00
        };

        function formatCurrency(n) { return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n); }

        function createInitialBettingTable() {
            const body = document.querySelector('#bettingTable tbody');
            body.innerHTML = ''; sessionData.betHistory = [];
            for (let i = 1; i <= 50; i++) {
                const row = body.insertRow(); row.id = `stepRow-${i}`;
                row.innerHTML = `<td>${i}</td><td data-col="color">0.00â‚¬</td><td data-col="line">0.00â‚¬</td><td data-col="dozen">0.00â‚¬</td><td data-col="totBet">0.00â‚¬</td><td data-col="netto">0.00â‚¬</td>`;
                sessionData.betHistory.push({ step: i, colorBet: 0, lineBet: 0, dozenBet: 0, totalBet: 0, netto: 0, isPlayed: false });
            }
        }

        // === MODIFICA LOGICA RICHIESTA (UNICA MODIFICA) ===
        function calculateBetFactors() {
            const numbers = sessionData.extractedNumbers.slice(-9);
            if (numbers.length < 9) return;

            const counts = { RED: 0, BLACK: 0, D1: 0, D3: 0 };
            numbers.forEach(n => {
                if (n === 0) return;
                if (ROULETTE_MAP.RED.includes(n)) counts.RED++;
                if (ROULETTE_MAP.BLACK.includes(n)) counts.BLACK++;
                if (ROULETTE_MAP.D1.includes(n)) counts.D1++;
                if (ROULETTE_MAP.D3.includes(n)) counts.D3++;
            });

            // Colore e Dozzina: Chi Ã¨ uscito meno
            sessionData.betFactors.color = counts.RED <= counts.BLACK ? 'RED' : 'BLACK';
            sessionData.betFactors.dozen = counts.D1 <= counts.D3 ? 'D1' : 'D3';

            // NUOVA REGOLA: Riga dipende dal colore
            sessionData.betFactors.line = (sessionData.betFactors.color === 'RED') ? 'L3' : 'L2';

            updateScommessaUI();
        }

        function updateScommessaUI() {
            const f = sessionData.betFactors;
            const displayColor = f.color === 'RED' ? 'ROSSO' : 'NERO';
            const displayLine = f.line === 'L3' ? 'LINEA 3 (3-36)' : 'LINEA 2 (2-35)';
            const displayDozen = f.dozen === 'D1' ? 'DOZZINA 1' : 'DOZZINA 3';
            
            document.getElementById('scommessaValue').innerHTML = `<span style="color:${f.color==='RED'?'red':'black'}">${displayColor}</span> | ${displayLine} | ${displayDozen}`;
        }

        // === LOGICA DI GIOCO RIPRISTINATA ===
        function processExtraction(n) {
            const step = sessionData.currentStep;
            const bet = sessionData.betHistory[step - 1];
            let win = 0; let hits = 0;

            if (ROULETTE_MAP[sessionData.betFactors.color].includes(n)) { win += bet.colorBet * 2; hits++; }
            if (ROULETTE_MAP[sessionData.betFactors.line].includes(n)) { win += bet.lineBet * 3; hits++; }
            if (ROULETTE_MAP[sessionData.betFactors.dozen].includes(n)) { win += bet.dozenBet * 3; hits++; }

            const netto = parseFloat((win - bet.totalBet).toFixed(2));
            bet.netto = netto;
            sessionData.saldoRealTime = parseFloat((sessionData.saldoRealTime + netto).toFixed(2));

            const row = document.getElementById(`stepRow-${step}`);
            row.classList.remove('highlighted-row');
            row.querySelector('[data-col="netto"]').textContent = formatCurrency(netto);
            row.querySelector('[data-col="netto"]').style.color = netto >= 0 ? 'green' : 'red';

            document.getElementById('saldoRealTimeValue').textContent = formatCurrency(sessionData.saldoRealTime);
            document.getElementById('saldoRealTimeValue').style.color = sessionData.saldoRealTime >= 0 ? 'green' : 'red';

            if (sessionData.saldoRealTime > 0) {
                alert(`ðŸŽ‰ VINTO ${formatCurrency(sessionData.saldoRealTime)}! Archivia la sessione.`);
                return;
            }
            if (step < 50) setupNextStep(step + 1, hits === 0 ? bet.colorBet + parseFloat(document.getElementById('puntataInput').value) : bet.colorBet);
        }

        function setupNextStep(s, amt) {
            sessionData.currentStep = s;
            const b = sessionData.betHistory[s - 1];
            b.colorBet = b.lineBet = b.dozenBet = amt;
            b.totalBet = parseFloat((amt * 3).toFixed(2));
            b.isPlayed = true;

            const row = document.getElementById(`stepRow-${s}`);
            row.classList.add('highlighted-row');
            row.querySelector('[data-col="color"]').textContent = formatCurrency(amt);
            row.querySelector('[data-col="line"]').textContent = formatCurrency(amt);
            row.querySelector('[data-col="dozen"]').textContent = formatCurrency(amt);
            row.querySelector('[data-col="totBet"]').textContent = formatCurrency(b.totalBet);
        }

        // === FUNZIONI ARCHIVIO COMPLETE E FUNZIONANTI ===
        async function save() {
            if(sessionData.currentStep === 0) return alert("Nessuna sessione attiva.");
            try {
                const resLoad = await fetch(`${API_URL}/latest`, { headers: {'X-ACCESS-KEY': API_KEY}});
                const data = await resLoad.json();
                let list = Array.isArray(data.record) ? data.record : [];
                list.push({
                    dataOra: new Date().toLocaleString('it-IT'),
                    netto: sessionData.saldoRealTime,
                    investimentoIniziale: parseFloat(document.getElementById('puntataInput').value),
                    stepChiusura: sessionData.currentStep,
                    extractedNumbers: [...sessionData.extractedNumbers]
                });
                await fetch(API_URL, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json', 'X-ACCESS-KEY': API_KEY},
                    body: JSON.stringify(list)
                });
                alert("Sessione Archiviata!"); location.reload();
            } catch(e) { alert("Errore connessione."); }
        }

        async function loadArchive() {
            try {
                const res = await fetch(`${API_URL}/latest`, { headers: {'X-ACCESS-KEY': API_KEY}});
                const data = await res.json();
                const list = Array.isArray(data.record) ? data.record : [];
                const tbody = document.querySelector('#archiveTable tbody');
                tbody.innerHTML = ''; let total = 0;

                list.slice().reverse().forEach(i => {
                    const netto = parseFloat(i.netto) || 0;
                    total += netto;
                    const r = tbody.insertRow();
                    const [d, t] = i.dataOra.split(' ');
                    r.innerHTML = `<td>${d}</td><td>${t}</td><td style="color:${netto>=0?'green':'red'}">${formatCurrency(netto)}</td><td>${formatCurrency(i.investimentoIniziale)}</td><td>${i.stepChiusura}</td>`;
                });
                const cEl = document.getElementById('cassaStoricaValue');
                cEl.textContent = formatCurrency(total);
                cEl.style.color = total >= 0 ? 'black' : 'white';
                cEl.parentElement.style.backgroundColor = total >= 0 ? 'var(--green-light)' : 'var(--red)';
            } catch(e) { console.error(e); }
        }

        async function recall() {
            try {
                const res = await fetch(`${API_URL}/latest`, { headers: {'X-ACCESS-KEY': API_KEY}});
                const data = await res.json();
                const list = Array.isArray(data.record) ? data.record : [];
                const last = list.reverse().find(s => s.extractedNumbers && s.extractedNumbers.length > 0);
                if(!last) return alert("Nessuna sessione.");
                sessionData.extractedNumbers = last.extractedNumbers.filter(n => n !== 0).slice(-7);
                updateNumbersUI(); calculateBetFactors();
                alert(`Richiamati ${sessionData.extractedNumbers.length} numeri.`);
            } catch(e) { alert("Errore recupero."); }
        }

        function updateNumbersUI() {
            const row = document.getElementById('lastNineNumbersRow');
            row.innerHTML = '';
            sessionData.extractedNumbers.slice(-9).forEach(n => {
                const cell = row.insertCell(); cell.textContent = n;
                cell.style.backgroundColor = n === 0 ? 'var(--green-light)' : (ROULETTE_MAP.RED.includes(n) ? 'var(--red)' : 'var(--black)');
                cell.style.color = 'white';
            });
        }

        // Inizializzazione e Eventi
        document.getElementById('numeroEstratto').addEventListener('keydown', e => {
            if(e.key === 'Enter') {
                const n = parseInt(e.target.value);
                if(isNaN(n) || n<0 || n>36) return;
                sessionData.extractedNumbers.push(n);
                e.target.value = ''; updateNumbersUI();
                if(sessionData.extractedNumbers.length >= 9) {
                    if(sessionData.currentStep === 0) {
                        calculateBetFactors();
                        setupNextStep(1, parseFloat(document.getElementById('puntataInput').value));
                        alert("ðŸ”” STRATEGIA INIZIATA!");
                    } else processExtraction(n);
                }
            }
        });

        document.getElementById('btnArchivia').addEventListener('click', save);
        document.getElementById('btnRecallLast7').addEventListener('click', recall);
        document.getElementById('btnToArchive').addEventListener('click', () => {
            document.getElementById('gameView').style.display = 'none';
            document.getElementById('archiveView').style.display = 'block';
            loadArchive();
        });
        document.getElementById('btnToGameFromArchive').addEventListener('click', () => {
            document.getElementById('gameView').style.display = 'block';
            document.getElementById('archiveView').style.display = 'none';
        });
        document.getElementById('btnResetSession').addEventListener('click', () => location.reload());
        document.getElementById('btnResetArchive').addEventListener('click', async () => {
            if(confirm("Reset totale?")) {
                await fetch(API_URL, { method: 'PUT', headers: {'Content-Type': 'application/json', 'X-ACCESS-KEY': API_KEY}, body: JSON.stringify([]) });
                loadArchive();
            }
        });

        window.onload = () => { createInitialBettingTable(); document.getElementById('numeroEstratto').focus(); };
    </script>
</body>
</html>
