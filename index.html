<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Tracker & Strategia</title>
    <link rel="icon" href="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" type="image/png">
    <style>
        :root {
            --green-dark: #006400;
            --green-light: #90ee90;
            --red: #ff4500;
            --black: #000000;
            --white: #ffffff;
            --gold: #ffd700;
            --gray-light: #f0f0f0;
            --blue-recall: #007bff;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--green-dark);
            color: var(--white);
            transition: background-color 0.5s;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 10px;
        }

        .header h1 {
            text-align: center;
            color: var(--gold);
            margin-bottom: 5px;
        }
        
        .header img {
            max-width: 50%;
            max-height: 12vh;
            height: auto;
            display: block;
            margin: 0 auto;
            padding-top: 5px;
            padding-bottom: 5px;
            box-sizing: border-box;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid var(--gold);
            box-sizing: border-box;
            background-color: var(--white);
            color: var(--black);
            font-size: 1.1em;
            text-align: center;
        }

        .info-box {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        #saldoRealTimeContainer {
            text-align: center;
        }
        
        #saldoRealTimeValue {
            font-size: 2em;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            padding: 5px;
            border-radius: 5px;
            background-color: var(--white);
            color: var(--red);
        }

        #scommessaContainer {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--black);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #scommessaContainer h3 {
            margin-top: 0;
            color: var(--green-dark);
        }

        #scommessaValue {
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1.5;
            color: var(--black);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        th, td {
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 0.9em;
        }

        th {
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--gold);
            position: sticky;
            top: 0;
        }
        
        .highlighted-row {
            background-color: var(--green-light) !important;
            color: var(--black);
            font-weight: bold;
        }

        .button-group, .button-group-archive {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        .main-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px; 
            margin-bottom: 15px; 
        }
        
        .main-buttons-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex-grow: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 0.9em;
            min-width: 100px;
        }
        
        #btnArchivia { background-color: #1e90ff; color: var(--white); }
        #btnResetSession { background-color: #dc3545; color: var(--white); }
        #btnToArchive { background-color: #ffc107; color: var(--black); }
        #btnRecallLast7 { background-color: var(--blue-recall); color: var(--white); }
        #btnToGameFromArchive { background-color: #28a745; color: var(--white); }
        #btnResetArchive { background-color: #6c757d; color: var(--white); }

        .view { display: none; }
        #gameView { display: block; }

        #archiveView {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            min-height: 100vh;
        }
        
        #archiveView table {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--black);
        }

        #cassaStoricaContainer {
            text-align: center;
            background-color: var(--gold);
            color: var(--black);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        #cassaStoricaValue {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        @media (max-width: 600px) {
            .main-buttons-row { flex-direction: column; gap: 5px; }
            .main-buttons-container button { min-width: 100%; }
            #archiveTable th, #archiveTable td { font-size: 0.6em; }
        }
    </style>
</head>
<body>

    <div id="gameView" class="view container">
        <div class="header">
            <img src="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" alt="Logo">
        </div>

        <div class="info-box">
            <label for="numeroEstratto">NUOVO NUMERO ESTRATTO (0-36):</label>
            <input type="number" id="numeroEstratto" inputmode="numeric" pattern="[0-9]*" min="0" max="36" placeholder="Inserisci numero" autofocus>
            
            <label for="puntataInput">PUNTATA (Valore di 1 Fiche in â‚¬):</label>
            <input type="number" id="puntataInput" min="0.01" step="0.01" value="0.10" placeholder="0.10">
        </div>

        <div id="saldoRealTimeContainer" class="info-box">
            <label>SALDO REAL TIME</label>
            <span id="saldoRealTimeValue">0.00â‚¬</span>
        </div>
        
        <div class="main-buttons-container">
            <div class="main-buttons-row">
                <button id="btnArchivia">Archivia Sessione</button>
                <button id="btnResetSession">Reset Sessione</button>
                <button id="btnToArchive">Archivio</button>
            </div>
            <button id="btnRecallLast7">Richiama Ultimi 7 Numeri</button>
        </div>
        
        <div class="info-box">
            <h3>AREA DATI - Ultimi Numeri Estratti</h3>
            <table id="dataAreaTable">
                <thead>
                    <tr><th colspan="9">ULTIMI 9 NUMERI</th></tr>
                </thead>
                <tbody>
                    <tr id="lastNineNumbersRow"></tr>
                </tbody>
            </table>
        </div>

        <div id="scommessaContainer">
            <h3>SCOMMESSA (Fattori da Puntare)</h3>
            <p id="scommessaValue">Inserisci 9 numeri per calcolare...</p>
        </div>

        <div class="info-box">
            <h3>LOGICA DI GIOCO (Step di 50 Max)</h3>
            <table id="bettingTable">
                <thead>
                    <tr>
                        <th>STEP</th>
                        <th>COLORE</th>
                        <th>LINEA</th>
                        <th>DOZZINA</th>
                        <th>TOT. BET (â‚¬)</th>
                        <th>NETTO EVENTO (â‚¬)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="archiveView" class="view">
        <div class="container">
            <div class="header">
                <h1>ðŸ“š Archivio Sessioni</h1>
            </div>
            <div id="cassaStoricaContainer">
                <label>CASSA STORICA NETTA</label>
                <span id="cassaStoricaValue">0.00â‚¬</span>
            </div>
            <div class="button-group-archive">
                <button id="btnToGameFromArchive">Torna al Gioco</button>
                <button id="btnResetArchive">Reset Archivio Storico</button>
            </div>
            <div class="info-box" style="background-color: transparent;">
                <table id="archiveTable">
                    <thead>
                        <tr>
                            <th>DATA</th>
                            <th>ORA</th>
                            <th>NETTO (â‚¬)</th>
                            <th>INVEST. (â‚¬)</th>
                            <th>STEP</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const JSON_BIN_ID = '693c2d5343b1c97be9e984aa'; 
        const API_KEY = '$2a$10$ayP59Hfi7LkT35rikrQPk.p7vm9HN/Cko1Nwr2I0HrZyu0/1BVMLe'; 
        const API_URL = `https://api.jsonbin.io/v3/b/${JSON_BIN_ID}`;
        const LATEST_BIN_URL = `https://api.jsonbin.io/v3/b/${JSON_BIN_ID}/latest`;

        const ROULETTE_MAP = {
            'RED': [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36],
            'BLACK': [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35],
            'D1': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            'D2': [13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
            'D3': [25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36],
            'L1': [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34], 
            'L2': [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35], 
            'L3': [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36]  
        };
        const MAX_STEPS = 50;
        const ANALYSIS_COUNT = 9;

        let sessionData = {
            extractedNumbers: [],
            currentStep: 0,
            betFactors: { color: '', line: '', dozen: '' },
            betHistory: [],
            saldoRealTime: 0.00
        };

        const gameView = document.getElementById('gameView');
        const archiveView = document.getElementById('archiveView');
        const numeroEstrattoInput = document.getElementById('numeroEstratto');
        const puntataInput = document.getElementById('puntataInput');
        const saldoRealTimeValue = document.getElementById('saldoRealTimeValue');
        const scommessaValue = document.getElementById('scommessaValue');
        const scommessaContainer = document.getElementById('scommessaContainer');
        const dataAreaTable = document.getElementById('lastNineNumbersRow');
        const bettingTableBody = document.querySelector('#bettingTable tbody');
        const cassaStoricaValue = document.getElementById('cassaStoricaValue');
        const archiveTableBody = document.querySelector('#archiveTable tbody');

        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        function createInitialBettingTable() {
            bettingTableBody.innerHTML = '';
            sessionData.betHistory = [];
            for (let i = 1; i <= MAX_STEPS; i++) {
                const row = bettingTableBody.insertRow();
                row.id = `stepRow-${i}`;
                row.innerHTML = `<td>${i}</td><td data-col="color">0.00â‚¬</td><td data-col="line">0.00â‚¬</td><td data-col="dozen">0.00â‚¬</td><td data-col="totBet">0.00â‚¬</td><td data-col="nettoEvento">0.00â‚¬</td>`;
                sessionData.betHistory.push({ step: i, colorBet: 0.00, lineBet: 0.00, dozenBet: 0.00, totalBet: 0.00, nettoEvento: 0.00, isPlayed: false });
            }
        }

        function updateDataAreaTable() {
            dataAreaTable.innerHTML = '';
            const lastNine = sessionData.extractedNumbers.slice(-ANALYSIS_COUNT); 
            for (let i = 0; i < ANALYSIS_COUNT; i++) {
                const number = lastNine[i] !== undefined ? lastNine[i] : '-';
                const cell = dataAreaTable.insertCell();
                cell.textContent = number;
                if (number !== '-') {
                    cell.style.backgroundColor = number === 0 ? 'var(--green-light)' : (ROULETTE_MAP.RED.includes(number) ? 'var(--red)' : 'var(--black)');
                    cell.style.color = (number === 0 || ROULETTE_MAP.RED.includes(number)) ? 'var(--white)' : 'var(--white)';
                }
            }
        }

        function resetSession() {
            sessionData.extractedNumbers = [];
            sessionData.currentStep = 0;
            sessionData.saldoRealTime = 0.00;
            puntataInput.value = "0.10";
            numeroEstrattoInput.value = '';
            saldoRealTimeValue.textContent = formatCurrency(0.00);
            scommessaValue.textContent = 'Inserisci 9 numeri per calcolare...';
            createInitialBettingTable();
            updateDataAreaTable();
            numeroEstrattoInput.focus();
        }

        // === NUOVA LOGICA CALCOLO FATTORI ===
        function calculateBetFactors() {
            const numbers = sessionData.extractedNumbers.slice(-ANALYSIS_COUNT);
            if (numbers.length < ANALYSIS_COUNT) {
                sessionData.betFactors = { color: '', line: '', dozen: '' };
                return;
            }

            const counts = { 'RED': 0, 'BLACK': 0, 'D1': 0, 'D3': 0 };

            numbers.forEach(num => {
                if (num === 0) return;
                if (ROULETTE_MAP.RED.includes(num)) counts.RED++;
                if (ROULETTE_MAP.BLACK.includes(num)) counts.BLACK++;
                if (ROULETTE_MAP.D1.includes(num)) counts.D1++;
                if (ROULETTE_MAP.D3.includes(num)) counts.D3++;
            });

            // 1. Colore (il meno uscito)
            sessionData.betFactors.color = counts.RED < counts.BLACK ? 'RED' : (counts.BLACK < counts.RED ? 'BLACK' : 'N/A');

            // 2. Riga (CONSEGUENZA DEL COLORE)
            if (sessionData.betFactors.color === 'RED') {
                sessionData.betFactors.line = 'L3';
            } else {
                // Se Nero o pareggio, propone Linea 2
                sessionData.betFactors.line = 'L2';
            }

            // 3. Dozzina (il meno uscito tra D1 e D3)
            sessionData.betFactors.dozen = counts.D1 <= counts.D3 ? 'D1' : 'D3';
            
            updateScommessaUI();
        }

        function updateScommessaUI() {
            const factors = sessionData.betFactors;
            let displayColor = factors.color === 'RED' ? 'ROSSO' : factors.color === 'BLACK' ? 'NERO' : 'N/A';
            let displayLine = factors.line === 'L2' ? 'LINEA 2 (2-35)' : 'LINEA 3 (3-36)';
            let displayDozen = factors.dozen === 'D1' ? 'DOZZINA 1 (1-12)' : 'DOZZINA 3 (25-36)';

            scommessaValue.innerHTML = `<span style="color: ${factors.color === 'RED' ? 'red' : 'black'}">${displayColor}</span><br>${displayLine}<br>${displayDozen}`;
            scommessaContainer.style.backgroundColor = 'var(--gold)';
        }

        function processExtraction(extractedNumber) {
            const currentStep = sessionData.currentStep;
            const bet = sessionData.betHistory[currentStep - 1];
            const puntataSingola = parseFloat(puntataInput.value);
            let winnings = 0;
            let hits = 0;

            if (ROULETTE_MAP[sessionData.betFactors.color]?.includes(extractedNumber)) { winnings += bet.colorBet * 2; hits++; }
            if (ROULETTE_MAP[sessionData.betFactors.line]?.includes(extractedNumber)) { winnings += bet.lineBet * 3; hits++; }
            if (ROULETTE_MAP[sessionData.betFactors.dozen]?.includes(extractedNumber)) { winnings += bet.dozenBet * 3; hits++; }

            const nettoEvento = parseFloat((winnings - bet.totalBet).toFixed(2));
            bet.nettoEvento = nettoEvento;
            sessionData.saldoRealTime = parseFloat((sessionData.saldoRealTime + nettoEvento).toFixed(2));

            updateBettingTableUI(currentStep);
            updateSaldoRealTimeUI();

            if (sessionData.saldoRealTime > 0) {
                alert(`ðŸŽ‰ VINTO ${formatCurrency(sessionData.saldoRealTime)}! Archivia la sessione.`);
                return;
            }

            if (currentStep < MAX_STEPS) {
                setupNextStep(currentStep + 1, hits === 0 ? bet.colorBet + puntataSingola : bet.colorBet);
            }
        }

        function setupNextStep(step, betAmount) {
            sessionData.currentStep = step;
            const nextBet = sessionData.betHistory[step - 1];
            nextBet.colorBet = nextBet.lineBet = nextBet.dozenBet = betAmount;
            nextBet.totalBet = parseFloat((betAmount * 3).toFixed(2));
            nextBet.isPlayed = true;
            const row = document.getElementById(`stepRow-${step}`);
            row.classList.add('highlighted-row');
            row.querySelector('td[data-col="color"]').textContent = formatCurrency(betAmount);
            row.querySelector('td[data-col="line"]').textContent = formatCurrency(betAmount);
            row.querySelector('td[data-col="dozen"]').textContent = formatCurrency(betAmount);
            row.querySelector('td[data-col="totBet"]').textContent = formatCurrency(nextBet.totalBet);
        }

        function updateBettingTableUI(step) {
            const bet = sessionData.betHistory[step - 1];
            const row = document.getElementById(`stepRow-${step}`);
            const nettoCell = row.querySelector('td[data-col="nettoEvento"]');
            nettoCell.textContent = formatCurrency(bet.nettoEvento);
            nettoCell.style.color = bet.nettoEvento >= 0 ? 'var(--green-dark)' : 'var(--red)';
            row.classList.remove('highlighted-row');
        }

        function updateSaldoRealTimeUI() {
            saldoRealTimeValue.textContent = formatCurrency(sessionData.saldoRealTime);
            saldoRealTimeValue.style.color = sessionData.saldoRealTime >= 0 ? 'var(--green-dark)' : 'var(--red)';
        }

        function handleNewNumber() {
            const num = parseInt(numeroEstrattoInput.value);
            if (isNaN(num) || num < 0 || num > 36) return;
            sessionData.extractedNumbers.push(num);
            numeroEstrattoInput.value = '';
            updateDataAreaTable();
            if (sessionData.extractedNumbers.length >= ANALYSIS_COUNT) {
                if (sessionData.currentStep === 0) {
                    calculateBetFactors();
                    setupNextStep(1, parseFloat(puntataInput.value));
                    alert("ðŸ”” STRATEGIA INIZIATA!");
                } else {
                    processExtraction(num);
                }
            }
        }

        numeroEstrattoInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleNewNumber(); });

        document.getElementById('btnToArchive').addEventListener('click', async () => {
            gameView.style.display = 'none';
            archiveView.style.display = 'block';
            const res = await fetch(LATEST_BIN_URL, { headers: { 'X-ACCESS-KEY': API_KEY } });
            const data = await res.json();
            const list = Array.isArray(data.record) ? data.record : [];
            archiveTableBody.innerHTML = '';
            let total = 0;
            list.reverse().forEach(item => {
                total += item.netto;
                const row = archiveTableBody.insertRow();
                row.innerHTML = `<td>${item.dataOra.split(' ')[0]}</td><td>${item.dataOra.split(' ')[1]}</td><td>${formatCurrency(item.netto)}</td><td>${formatCurrency(item.investimentoIniziale)}</td><td>${item.stepChiusura}</td>`;
            });
            cassaStoricaValue.textContent = formatCurrency(total);
        });

        document.getElementById('btnToGameFromArchive').addEventListener('click', () => { archiveView.style.display = 'none'; gameView.style.display = 'block'; });
        document.getElementById('btnResetSession').addEventListener('click', () => { if(confirm("Resettare?")) resetSession(); });
        
        window.onload = resetSession;
    </script>
</body>
</html>
