<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Tracker & Strategia</title>
    <link rel="icon" href="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" type="image/png">
    <style>
        /* CSS per Stile e Responsiveness */
        :root {
            --green-dark: #006400; /* Verde scuro, come un tavolo da roulette */
            --green-light: #90ee90; /* Verde chiaro per evidenziare */
            --red: #ff4500; /* Rosso per il testo saldo negativo */
            --black: #000000;
            --white: #ffffff;
            --gold: #ffd700;
            --gray-light: #f0f0f0;
            --blue-recall: #007bff; /* Blu per il nuovo pulsante */
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--green-dark);
            color: var(--white);
            transition: background-color 0.5s;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 10px;
        }

        /* Testo e Campi di Input */
        .header h1 {
            text-align: center;
            color: var(--gold);
            margin-bottom: 5px;
        }
        
        /* STILE IMMAGINE: Rimpicciolito */
        .header img {
            max-width: 50%; /* Larghezza ridotta */
            max-height: 12vh; /* Altezza massima per viewport */
            height: auto;
            display: block;
            margin: 0 auto; /* Centra l'immagine */
            padding-top: 5px; /* Padding leggermente ridotto */
            padding-bottom: 5px;
            box-sizing: border-box;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid var(--gold);
            box-sizing: border-box;
            background-color: var(--white);
            color: var(--black);
            font-size: 1.1em;
            text-align: center;
        }

        /* Contenitori per Saldo e Scommessa */
        .info-box {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        #saldoRealTimeContainer {
            text-align: center;
        }
        
        #saldoRealTimeValue {
            font-size: 2em;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            padding: 5px;
            border-radius: 5px;
            background-color: var(--white);
            color: var(--red); /* Default negativo */
        }

        #scommessaContainer {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--black);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #scommessaContainer h3 {
            margin-top: 0;
            color: var(--green-dark);
        }

        #scommessaValue {
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1.5;
            color: var(--black);
        }

        /* Tabelle */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        th, td {
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 0.9em;
        }

        th {
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--gold);
            position: sticky;
            top: 0;
        }
        
        /* Stile specifico per le celle data/ora nell'archivio */
        #archiveTable th:nth-child(1), #archiveTable td:nth-child(1), 
        #archiveTable th:nth-child(2), #archiveTable td:nth-child(2) { 
            font-size: 0.8em; 
            white-space: nowrap;
        }

        .highlighted-row {
            background-color: var(--green-light) !important;
            color: var(--black);
            font-weight: bold;
        }

        /* Pulsanti */
        .button-group, .button-group-archive {
            display: flex;
            gap: 10px;
            margin-top: 20px; /* Spazio dopo Cassa Storica */
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        /* Contenitore pulsanti principale */
        .main-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px; 
            margin-bottom: 15px; 
        }
        
        .main-buttons-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* DIMENSIONE PULSANTI RIMODIFICATA */
        button {
            flex-grow: 1;
            padding: 8px 10px; /* Rimpicciolisci il padding */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 0.9em; /* Rimpicciolisci leggermente il font */
            min-width: 100px;
        }
        
        #btnArchivia { background-color: #1e90ff; color: var(--white); }
        #btnArchivia:hover { background-color: #4169e1; }

        #btnResetSession { background-color: #dc3545; color: var(--white); }
        #btnResetSession:hover { background-color: #c82333; }

        #btnToArchive { background-color: #ffc107; color: var(--black); }
        #btnToArchive:hover { background-color: #e0a800; }
        
        #btnRecallLast7 { background-color: var(--blue-recall); color: var(--white); }
        #btnRecallLast7:hover { background-color: #0056b3; }
        
        #btnToGameFromArchive { background-color: #28a745; color: var(--white); }
        #btnToGameFromArchive:hover { background-color: #1e7e34; }
        
        #btnResetArchive { background-color: #6c757d; color: var(--white); }
        #btnResetArchive:hover { background-color: #5a6268; }

        /* Viste (Gioco e Archivio) */
        .view {
            display: none;
        }
        
        /* Assicuriamo che la vista di gioco sia impostata inizialmente */
        #gameView {
            display: block; 
        }

        #archiveView {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            min-height: 100vh;
        }
        
        #archiveView table {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--black);
        }
        
        #archiveView th, #archiveView td {
            border-color: rgba(0, 0, 0, 0.3);
        }

        #cassaStoricaContainer {
            text-align: center;
            background-color: var(--gold);
            color: var(--black);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        #cassaStoricaValue {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        /* Media Queries per Ottimizzazione Mobile */
        @media (max-width: 600px) {
            .container {
                padding: 5px;
            }
            input[type="number"], input[type="text"] {
                font-size: 1em;
            }
            th, td {
                padding: 6px 4px;
                font-size: 0.75em;
            }
            .info-box {
                padding: 10px;
            }
            #saldoRealTimeValue {
                font-size: 1.5em;
            }
            /* Su mobile i pulsanti restano a piena larghezza ma con padding ridotto */
            .main-buttons-row {
                flex-direction: column;
                gap: 5px;
            }
            .main-buttons-container button {
                min-width: 100%;
                padding: 8px 10px; /* Mantieni il padding ridotto anche su mobile */
            }

            .header h1 {
                font-size: 1.5em;
            }
            /* Riduce la dimensione della data/ora sul mobile */
            #archiveTable th:nth-child(1), #archiveTable td:nth-child(1) {
                font-size: 0.6em;
            }
            #archiveTable th:nth-child(2), #archiveTable td:nth-child(2) {
                font-size: 0.6em;
            }
        }
    </style>
</head>
<body>

    <div id="gameView" class="view container">
        <div class="header">
            <img src="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" alt="Logo Roulette Tracker">
        </div>

        <div class="info-box">
            <label for="numeroEstratto">NUOVO NUMERO ESTRATTO (0-36):</label>
            <input type="number" id="numeroEstratto" inputmode="numeric" pattern="[0-9]*" min="0" max="36" placeholder="Inserisci numero" autofocus>
            
            <label for="puntataInput">PUNTATA (Valore di 1 Fiche in â‚¬):</label>
            <input type="number" id="puntataInput" min="0.01" step="0.01" value="0.10" placeholder="0.10">
        </div>

        <div id="saldoRealTimeContainer" class="info-box">
            <label>SALDO REAL TIME</label>
            <span id="saldoRealTimeValue">0.00â‚¬</span>
        </div>
        
        <div class="main-buttons-container">
            <div class="main-buttons-row">
                <button id="btnArchivia">Archivia Sessione</button>
                <button id="btnResetSession">Reset Sessione</button>
                <button id="btnToArchive">Archivio</button>
            </div>
            <button id="btnRecallLast7">Richiama Ultimi 7 Numeri</button>
        </div>
        <div class="info-box">
            <h3>AREA DATI - Ultimi Numeri Estratti</h3>
            <table id="dataAreaTable">
                <thead>
                    <tr><th colspan="9">ULTIMI 9 NUMERI</th></tr>
                </thead>
                <tbody>
                    <tr id="lastNineNumbersRow"></tr>
                </tbody>
            </table>
        </div>

        <div id="scommessaContainer">
            <h3>SCOMMESSA (Fattori da Puntare)</h3>
            <p id="scommessaValue">Inserisci 9 numeri per calcolare...</p>
        </div>

        <div class="info-box">
            <h3>LOGICA DI GIOCO (Step di 50 Max)</h3>
            <table id="bettingTable">
                <thead>
                    <tr>
                        <th>STEP</th>
                        <th>COLORE</th>
                        <th>LINEA</th>
                        <th>DOZZINA</th>
                        <th>TOT. BET (â‚¬)</th>
                        <th>NETTO EVENTO (â‚¬)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div id="archiveView" class="view">
        <div class="container">
            <div class="header">
                <h1>ðŸ“š Archivio Sessioni</h1>
            </div>

            <div id="cassaStoricaContainer">
                <label>CASSA STORICA NETTA</label>
                <span id="cassaStoricaValue">0.00â‚¬</span>
            </div>
            
            <div class="button-group-archive">
                <button id="btnToGameFromArchive">Torna al Gioco</button>
                <button id="btnResetArchive">Reset Archivio Storico</button>
            </div>
            <div class="info-box" style="background-color: transparent;">
                <table id="archiveTable">
                    <thead>
                        <tr>
                            <th>DATA</th>
                            <th>ORA</th>
                            <th>NETTO (â‚¬)</th>
                            <th>INVEST. INIZIALE (â‚¬)</th>
                            <th>STEP CHIUSURA</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

        </div>
    </div>

    <script>
        // === DATI E CONFIGURAZIONE GLOBALE ===

        // Configurazione per jsonbin.io
        const JSON_BIN_ID = '693c2d5343b1c97be9e984aa'; 
        const API_KEY = '$2a$10$ayP59Hfi7LkT35rikrQPk.p7vm9HN/Cko1Nwr2I0HrZyu0/1BVMLe'; 
        const API_URL = `https://api.jsonbin.io/v3/b/${JSON_BIN_ID}`;
        const LATEST_BIN_URL = `https://api.jsonbin.io/v3/b/${JSON_BIN_ID}/latest`;


        // Mappatura Roulette
        const ROULETTE_MAP = {
            'RED': [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36],
            'BLACK': [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35],
            'D1': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            'D2': [13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
            'D3': [25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36],
            'L1': [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34], 
            'L2': [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35], 
            'L3': [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36]  
        };
        const MAX_STEPS = 50;
        const ANALYSIS_COUNT = 9;

        let sessionData = {
            extractedNumbers: [],
            currentStep: 0,
            betFactors: { color: '', line: '', dozen: '' }, 
            betHistory: [], 
            saldoRealTime: 0.00
        };

        const gameView = document.getElementById('gameView');
        const archiveView = document.getElementById('archiveView');
        const numeroEstrattoInput = document.getElementById('numeroEstratto');
        const puntataInput = document.getElementById('puntataInput');
        const saldoRealTimeValue = document.getElementById('saldoRealTimeValue');
        const scommessaValue = document.getElementById('scommessaValue');
        const scommessaContainer = document.getElementById('scommessaContainer');
        const dataAreaTable = document.getElementById('lastNineNumbersRow');
        const bettingTableBody = document.querySelector('#bettingTable tbody');
        const cassaStoricaValue = document.getElementById('cassaStoricaValue');
        const archiveTableBody = document.querySelector('#archiveTable tbody');

        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        function createInitialBettingTable() {
            bettingTableBody.innerHTML = '';
            sessionData.betHistory = [];
            for (let i = 1; i <= MAX_STEPS; i++) {
                const row = bettingTableBody.insertRow();
                row.id = `stepRow-${i}`;
                row.innerHTML = `
                    <td>${i}</td>
                    <td data-col="color">0.00â‚¬</td>
                    <td data-col="line">0.00â‚¬</td>
                    <td data-col="dozen">0.00â‚¬</td>
                    <td data-col="totBet">0.00â‚¬</td>
                    <td data-col="nettoEvento">0.00â‚¬</td>
                `;
                sessionData.betHistory.push({
                    step: i,
                    colorBet: 0.00,
                    lineBet: 0.00,
                    dozenBet: 0.00,
                    totalBet: 0.00,
                    nettoEvento: 0.00,
                    isPlayed: false 
                });
            }
        }

        function updateDataAreaTable() {
            dataAreaTable.innerHTML = '';
            const lastNine = sessionData.extractedNumbers.slice(-ANALYSIS_COUNT); 
            for (let i = 0; i < ANALYSIS_COUNT; i++) {
                const number = lastNine[i] !== undefined ? lastNine[i] : '-';
                const cell = dataAreaTable.insertCell();
                cell.textContent = number;
                let bgColor = 'transparent';
                let textColor = 'var(--white)';
                if (number === 0) {
                    bgColor = 'var(--green-light)';
                    textColor = 'var(--black)';
                } else if (ROULETTE_MAP.RED.includes(number)) {
                    bgColor = 'var(--red)';
                    textColor = 'var(--white)';
                } else if (ROULETTE_MAP.BLACK.includes(number)) {
                    bgColor = 'var(--black)';
                    textColor = 'var(--white)';
                }
                cell.style.backgroundColor = bgColor;
                cell.style.color = textColor;
            }
        }

        function calculateBetFactors() {
            const numbers = sessionData.extractedNumbers.slice(-ANALYSIS_COUNT);
            if (numbers.length < ANALYSIS_COUNT) return;

            const counts = { 'RED': 0, 'BLACK': 0, 'D1': 0, 'D3': 0 };
            numbers.forEach(num => {
                if (num === 0) return;
                if (ROULETTE_MAP.RED.includes(num)) counts.RED++;
                if (ROULETTE_MAP.BLACK.includes(num)) counts.BLACK++;
                if (ROULETTE_MAP.D1.includes(num)) counts.D1++;
                if (ROULETTE_MAP.D3.includes(num)) counts.D3++;
            });

            // LOGICA COLORE E DOZZINA: Chi Ã¨ uscito meno
            sessionData.betFactors.color = counts.RED <= counts.BLACK ? 'RED' : 'BLACK';
            sessionData.betFactors.dozen = counts.D1 <= counts.D3 ? 'D1' : 'D3';

            // NUOVA LOGICA RIGA: Dipende dal colore
            sessionData.betFactors.line = (sessionData.betFactors.color === 'RED') ? 'L3' : 'L2';
            
            updateScommessaUI();
        }

        function updateScommessaUI() {
            const factors = sessionData.betFactors;
            let displayColor = factors.color === 'RED' ? 'ROSSO' : 'NERO';
            let displayLine = factors.line === 'L2' ? 'LINEA 2 (2-35)' : 'LINEA 3 (3-36)';
            let displayDozen = factors.dozen === 'D1' ? 'DOZZINA 1 (1-12)' : 'DOZZINA 3 (25-36)';

            scommessaValue.innerHTML = `
                <span style="color: ${factors.color === 'RED' ? 'red' : 'black'}; background-color: ${factors.color === 'BLACK' ? 'white' : 'transparent'}; padding: 2px 5px; border-radius: 3px;">${displayColor}</span><br>
                ${displayLine}<br>
                ${displayDozen}
            `;
            scommessaContainer.style.backgroundColor = 'var(--gold)';
        }

        function processExtraction(extractedNumber) {
            const currentStep = sessionData.currentStep;
            const bet = sessionData.betHistory[currentStep - 1];
            const puntataSingola = parseFloat(puntataInput.value);

            let winnings = 0; let hits = 0;
            const betAmount = bet.colorBet;

            if (ROULETTE_MAP[sessionData.betFactors.color].includes(extractedNumber) && extractedNumber !== 0) {
                winnings += betAmount * 2; hits++;
            }
            if (ROULETTE_MAP[sessionData.betFactors.line].includes(extractedNumber) && extractedNumber !== 0) {
                winnings += betAmount * 3; hits++;
            }
            if (ROULETTE_MAP[sessionData.betFactors.dozen].includes(extractedNumber) && extractedNumber !== 0) {
                winnings += betAmount * 3; hits++;
            }

            const nettoEvento = parseFloat((winnings - bet.totalBet).toFixed(2));
            bet.nettoEvento = nettoEvento;
            sessionData.saldoRealTime = parseFloat((sessionData.saldoRealTime + nettoEvento).toFixed(2));

            updateBettingTableUI(currentStep);
            saldoRealTimeValue.textContent = formatCurrency(sessionData.saldoRealTime);
            saldoRealTimeValue.style.color = sessionData.saldoRealTime >= 0 ? 'green' : 'var(--red)';

            if (sessionData.saldoRealTime > 0) {
                alert(`ðŸŽ‰ VINTO ${formatCurrency(sessionData.saldoRealTime)}! Archivia la sessione.`);
                return;
            }

            let nextStep = currentStep + 1;
            if (nextStep <= MAX_STEPS) {
                setupNextStep(nextStep, hits === 0 ? bet.colorBet + puntataSingola : bet.colorBet);
            }
        }

        function setupNextStep(step, betAmount) {
            sessionData.currentStep = step;
            const nextBet = sessionData.betHistory[step - 1];
            const row = document.getElementById(`stepRow-${step}`);
            nextBet.colorBet = nextBet.lineBet = nextBet.dozenBet = betAmount;
            nextBet.totalBet = parseFloat((betAmount * 3).toFixed(2));
            nextBet.isPlayed = true;
            row.classList.add('highlighted-row');
            row.querySelector('td[data-col="color"]').textContent = formatCurrency(betAmount);
            row.querySelector('td[data-col="line"]').textContent = formatCurrency(betAmount);
            row.querySelector('td[data-col="dozen"]').textContent = formatCurrency(betAmount);
            row.querySelector('td[data-col="totBet"]').textContent = formatCurrency(nextBet.totalBet);
            if (step > 1) document.getElementById(`stepRow-${step-1}`).classList.remove('highlighted-row');
        }

        function updateBettingTableUI(step) {
            const bet = sessionData.betHistory[step - 1];
            const cell = document.getElementById(`stepRow-${step}`).querySelector('td[data-col="nettoEvento"]');
            cell.textContent = formatCurrency(bet.nettoEvento);
            cell.style.color = bet.nettoEvento >= 0 ? 'green' : 'red';
        }

        // --- GESTIONE ARCHIVIO ---
        async function saveSession() {
            if(sessionData.currentStep === 0) return alert("Nessuna sessione attiva.");
            try {
                const res = await fetch(LATEST_BIN_URL, { headers: {'X-ACCESS-KEY': API_KEY}});
                const data = await res.json();
                let list = Array.isArray(data.record) ? data.record : [];
                list.push({
                    dataOra: new Date().toLocaleString('it-IT'),
                    netto: sessionData.saldoRealTime,
                    investimentoIniziale: parseFloat(puntataInput.value),
                    stepChiusura: sessionData.currentStep,
                    extractedNumbers: [...sessionData.extractedNumbers]
                });
                await fetch(API_URL, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json', 'X-ACCESS-KEY': API_KEY},
                    body: JSON.stringify(list)
                });
                alert("Sessione Archiviata!"); location.reload();
            } catch(e) { alert("Errore connessione."); }
        }

        async function loadArchive() {
            try {
                const res = await fetch(LATEST_BIN_URL, { headers: {'X-ACCESS-KEY': API_KEY}});
                const data = await res.json();
                const list = Array.isArray(data.record) ? data.record : [];
                archiveTableBody.innerHTML = ''; let total = 0;
                list.slice().reverse().forEach(i => {
                    const netto = parseFloat(i.netto) || 0; total += netto;
                    const r = archiveTableBody.insertRow();
                    const [d, t] = i.dataOra.split(' ');
                    r.innerHTML = `<td>${d}</td><td>${t}</td><td style="color:${netto>=0?'green':'red'}">${formatCurrency(netto)}</td><td>${formatCurrency(i.investimentoIniziale)}</td><td>${i.stepChiusura}</td>`;
                });
                cassaStoricaValue.textContent = formatCurrency(total);
                cassaStoricaValue.parentElement.style.backgroundColor = total >= 0 ? 'var(--gold)' : 'var(--red)';
            } catch(e) { console.error(e); }
        }

        numeroEstrattoInput.addEventListener('keydown', e => {
            if(e.key === 'Enter') {
                const n = parseInt(e.target.value);
                if(isNaN(n) || n<0 || n>36) return;
                sessionData.extractedNumbers.push(n);
                e.target.value = ''; updateDataAreaTable();
                if(sessionData.extractedNumbers.length >= 9) {
                    if(sessionData.currentStep === 0) {
                        calculateBetFactors();
                        setupNextStep(1, parseFloat(puntataInput.value));
                        alert("ðŸ”” STRATEGIA INIZIATA!");
                    } else processExtraction(n);
                }
            }
        });

        document.getElementById('btnArchivia').addEventListener('click', saveSession);
        document.getElementById('btnToArchive').addEventListener('click', () => {
            gameView.style.display = 'none'; archiveView.style.display = 'block'; loadArchive();
        });
        document.getElementById('btnToGameFromArchive').addEventListener('click', () => {
            gameView.style.display = 'block'; archiveView.style.display = 'none';
        });
        document.getElementById('btnResetSession').addEventListener('click', () => location.reload());
        document.getElementById('btnRecallLast7').addEventListener('click', async () => {
            try {
                const res = await fetch(LATEST_BIN_URL, { headers: {'X-ACCESS-KEY': API_KEY}});
                const data = await res.json();
                const last = data.record.reverse().find(s => s.extractedNumbers && s.extractedNumbers.length > 0);
                if(last) {
                    sessionData.extractedNumbers = last.extractedNumbers.filter(n => n !== 0).slice(-7);
                    updateDataAreaTable(); calculateBetFactors();
                    alert("Ultimi 7 numeri richiamati!");
                }
            } catch(e) { alert("Errore richiamo."); }
        });

        window.onload = createInitialBettingTable;
    </script>
</body>
</html>
