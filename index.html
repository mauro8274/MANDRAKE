<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Tracker - PRO</title>
    <link rel="icon" href="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" type="image/png">
    <style>
        :root {
            --green-dark: #006400;
            --green-light: #90ee90;
            --red: #ff4500;
            --black: #000000;
            --white: #ffffff;
            --gold: #ffd700;
            --blue-recall: #007bff;
        }

        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: var(--green-dark); color: var(--white); }
        .container { max-width: 1200px; margin: auto; padding: 10px; }
        .header img { max-width: 50%; max-height: 12vh; height: auto; display: block; margin: 0 auto; padding: 5px 0; }
        
        input[type="number"] { width: 100%; padding: 12px; margin: 5px 0 10px; border-radius: 5px; border: 1px solid var(--gold); box-sizing: border-box; font-size: 1.1em; text-align: center; }

        .info-box { background-color: rgba(0, 0, 0, 0.4); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); }
        #saldoRealTimeValue { font-size: 2em; font-weight: bold; display: block; text-align: center; padding: 5px; border-radius: 5px; background-color: var(--white); color: var(--red); }

        #scommessaContainer { text-align: center; background-color: rgba(255, 255, 255, 0.9); color: var(--black); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        #scommessaValue { font-size: 1.2em; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background-color: rgba(255, 255, 255, 0.1); }
        th, td { padding: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); font-size: 0.9em; }
        th { background-color: rgba(0, 0, 0, 0.5); color: var(--gold); }
        
        .highlighted-row { background-color: var(--green-light) !important; color: var(--black); font-weight: bold; }

        .main-buttons-container { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .main-buttons-row { display: flex; gap: 10px; flex-wrap: wrap; }
        
        button { flex-grow: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; min-width: 100px; }
        #btnArchivia { background-color: #1e90ff; color: white; }
        #btnResetSession { background-color: #dc3545; color: white; }
        #btnToArchive { background-color: #ffc107; color: black; }
        #btnRecallLast7 { background-color: var(--blue-recall); color: white; }
        #btnToGameFromArchive { background-color: #28a745; color: white; }
        #btnResetArchive { background-color: #6c757d; color: white; }

        .view { display: none; }
        #archiveView { background-color: rgba(0, 0, 0, 0.8); min-height: 100vh; padding: 20px; }
        #cassaStoricaValue { font-size: 2em; font-weight: bold; display: block; text-align: center; padding: 10px; border-radius: 8px; margin: 10px 0; }

        @media (max-width: 600px) { .main-buttons-row { flex-direction: column; } }
    </style>
</head>
<body>

    <div id="gameView" class="view" style="display: block;">
        <div class="container">
            <div class="header"><img src="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png"></div>
            
            <div class="info-box">
                <label>NUMERO ESTRATTO (0-36):</label>
                <input type="number" id="numeroEstratto" inputmode="numeric" autofocus>
                <label>PUNTATA BASE (â‚¬):</label>
                <input type="number" id="puntataInput" step="0.10" value="0.10">
            </div>

            <div class="info-box">
                <label style="text-align: center; display: block;">SALDO SESSIONE</label>
                <span id="saldoRealTimeValue">0.00â‚¬</span>
            </div>

            <div class="main-buttons-container">
                <div class="main-buttons-row">
                    <button id="btnArchivia">Archivia Sessione</button>
                    <button id="btnResetSession">Reset Sessione</button>
                    <button id="btnToArchive">Apri Archivio</button>
                </div>
                <button id="btnRecallLast7">Richiama Ultimi 7 Numeri</button>
            </div>

            <div class="info-box">
                <table id="dataAreaTable">
                    <thead><tr><th colspan="9">ULTIMI 9 NUMERI</th></tr></thead>
                    <tbody><tr id="lastNineNumbersRow"></tr></tbody>
                </table>
            </div>

            <div id="scommessaContainer">
                <h3>SCOMMESSA CONSIGLIATA</h3>
                <p id="scommessaValue">Inserisci 9 numeri...</p>
            </div>

            <div class="info-box">
                <table id="bettingTable">
                    <thead>
                        <tr><th>STEP</th><th>COLORE</th><th>LINEA</th><th>DOZZINA</th><th>TOT.</th><th>NETTO</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="archiveView" class="view">
        <div class="container">
            <h1 style="text-align: center; color: var(--gold);">Archivio Storico</h1>
            <div id="cassaStoricaContainer" class="info-box">
                <label style="text-align: center; display: block; color: white;">CASSA STORICA NETTA</label>
                <span id="cassaStoricaValue">0.00â‚¬</span>
            </div>
            <div class="main-buttons-row" style="margin-bottom: 20px;">
                <button id="btnToGameFromArchive">Torna al Gioco</button>
                <button id="btnResetArchive">Svuota Archivio</button>
            </div>
            <table id="archiveTable" style="background: white; color: black;">
                <thead>
                    <tr><th>DATA</th><th>ORA</th><th>NETTO</th><th>INVEST.</th><th>STEP</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const BIN_ID = '693c2d5343b1c97be9e984aa';
        const KEY = '$2a$10$ayP59Hfi7LkT35rikrQPk.p7vm9HN/Cko1Nwr2I0HrZyu0/1BVMLe';
        const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        const MAP = {
            'RED': [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36],
            'BLACK': [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35],
            'D1': [1,2,3,4,5,6,7,8,9,10,11,12], 'D3': [25,26,27,28,29,30,31,32,33,34,35,36],
            'L2': [2,5,8,11,14,17,20,23,26,29,32,35], 'L3': [3,6,9,12,15,18,21,24,27,30,33,36]
        };

        let state = { numbers: [], step: 0, saldo: 0, factors: {}, history: [] };

        function fmt(n) { return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n); }

        function initTable() {
            const body = document.querySelector('#bettingTable tbody');
            body.innerHTML = ''; state.history = [];
            for(let i=1; i<=50; i++) {
                const r = body.insertRow(); r.id = `row-${i}`;
                r.innerHTML = `<td>${i}</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>`;
                state.history.push({ step: i, played: false });
            }
        }

        function updateNumbersUI() {
            const row = document.getElementById('lastNineNumbersRow');
            row.innerHTML = '';
            state.numbers.slice(-9).forEach(n => {
                const c = row.insertCell(); c.textContent = n;
                c.style.background = n === 0 ? 'var(--green-light)' : (MAP.RED.includes(n) ? 'var(--red)' : 'black');
            });
        }

        // --- LOGICA RICHIESTA: RIGA DIPENDENTE DAL COLORE ---
        function calcFactors() {
            const last9 = state.numbers.slice(-9);
            const counts = { RED: 0, BLACK: 0, D1: 0, D3: 0 };
            last9.forEach(n => {
                if(n===0) return;
                if(MAP.RED.includes(n)) counts.RED++; else counts.BLACK++;
                if(MAP.D1.includes(n)) counts.D1++; else if(MAP.D3.includes(n)) counts.D3++;
            });

            state.factors.color = counts.RED <= counts.BLACK ? 'RED' : 'BLACK';
            state.factors.dozen = counts.D1 <= counts.D3 ? 'D1' : 'D3';
            
            // Logica Diretta: Rosso -> L3 | Nero -> L2
            state.factors.line = (state.factors.color === 'RED') ? 'L3' : 'L2';

            const sView = document.getElementById('scommessaValue');
            sView.innerHTML = `<b style="color:${state.factors.color==='RED'?'red':'black'}">${state.factors.color}</b> | ${state.factors.line} | ${state.factors.dozen}`;
        }

        async function handleInput() {
            const n = parseInt(document.getElementById('numeroEstratto').value);
            if(isNaN(n) || n<0 || n>36) return;
            state.numbers.push(n);
            document.getElementById('numeroEstratto').value = '';
            updateNumbersUI();

            if(state.numbers.length >= 9) {
                if(state.step === 0) {
                    calcFactors();
                    startStep(1, parseFloat(document.getElementById('puntataInput').value));
                    alert("ðŸ”” STRATEGIA INIZIATA!");
                } else {
                    processWinLoss(n);
                }
            }
        }

        function startStep(s, amt) {
            state.step = s;
            const h = state.history[s-1];
            h.amt = amt; h.total = amt * 3; h.played = true;
            const r = document.getElementById(`row-${s}`);
            r.classList.add('highlighted-row');
            r.cells[1].textContent = fmt(amt); r.cells[2].textContent = fmt(amt);
            r.cells[3].textContent = fmt(amt); r.cells[4].textContent = fmt(h.total);
        }

        function processWinLoss(n) {
            const h = state.history[state.step-1];
            let win = 0; let hits = 0;
            if(MAP[state.factors.color].includes(n)) { win += h.amt * 2; hits++; }
            if(MAP[state.factors.line].includes(n)) { win += h.amt * 3; hits++; }
            if(MAP[state.factors.dozen].includes(n)) { win += h.amt * 3; hits++; }

            const netto = win - h.total;
            state.saldo += netto;
            const r = document.getElementById(`row-${state.step}`);
            r.classList.remove('highlighted-row');
            r.cells[5].textContent = fmt(netto);
            r.cells[5].style.color = netto >= 0 ? 'green' : 'red';

            document.getElementById('saldoRealTimeValue').textContent = fmt(state.saldo);
            document.getElementById('saldoRealTimeValue').style.color = state.saldo >= 0 ? 'green' : 'red';

            if(state.saldo > 0) { alert("ðŸŽ‰ SESSIONE VINCENTE!"); return; }
            if(state.step < 50) startStep(state.step + 1, hits === 0 ? h.amt + parseFloat(document.getElementById('puntataInput').value) : h.amt);
        }

        // --- FUNZIONI ARCHIVIO E JSONBIN ---
        async function save() {
            if(state.step === 0) return alert("Nulla da salvare");
            try {
                const res = await fetch(`${URL}/latest`, { headers: {'X-Access-Key': KEY}});
                const data = await res.json();
                let list = Array.isArray(data.record) ? data.record : [];
                
                list.push({
                    dataOra: new Date().toLocaleString('it-IT'),
                    netto: state.saldo,
                    investimentoIniziale: parseFloat(document.getElementById('puntataInput').value),
                    stepChiusura: state.step,
                    extractedNumbers: [...state.numbers]
                });

                await fetch(URL, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json', 'X-Access-Key': KEY},
                    body: JSON.stringify(list)
                });
                alert("Archiviato!"); location.reload();
            } catch(e) { alert("Errore salvataggio"); }
        }

        async function loadArchive() {
            try {
                const res = await fetch(`${URL}/latest`, { headers: {'X-Access-Key': KEY}});
                const data = await res.json();
                const list = Array.isArray(data.record) ? data.record : [];
                const tbody = document.querySelector('#archiveTable tbody');
                tbody.innerHTML = '';
                let totalCassa = 0;

                list.slice().reverse().forEach(i => {
                    totalCassa += (parseFloat(i.netto) || 0);
                    const r = tbody.insertRow();
                    const [d, t] = i.dataOra.split(' ');
                    r.innerHTML = `<td>${d}</td><td>${t}</td><td>${fmt(i.netto)}</td><td>${fmt(i.investimentoIniziale)}</td><td>${i.stepChiusura}</td>`;
                });

                const cassaEl = document.getElementById('cassaStoricaValue');
                cassaEl.textContent = fmt(totalCassa);
                cassaEl.style.background = totalCassa >= 0 ? 'var(--green-light)' : 'var(--red)';
            } catch(e) { console.error(e); }
        }

        async function recall7() {
            try {
                const res = await fetch(`${URL}/latest`, { headers: {'X-Access-Key': KEY}});
                const data = await res.json();
                const list = Array.isArray(data.record) ? data.record : [];
                const last = list.filter(s => s.extractedNumbers).pop();
                if(!last) return alert("Nessun dato");
                
                state.numbers = last.extractedNumbers.filter(n => n !== 0).slice(-7);
                updateNumbersUI();
                if(state.numbers.length >= 9) calcFactors();
                alert("Numeri richiamati!");
            } catch(e) { alert("Errore richiamo"); }
        }

        // Events
        document.getElementById('numeroEstratto').addEventListener('keydown', e => { if(e.key==='Enter') handleInput(); });
        document.getElementById('btnArchivia').addEventListener('click', save);
        document.getElementById('btnRecallLast7').addEventListener('click', recall7);
        document.getElementById('btnToArchive').addEventListener('click', () => { 
            document.getElementById('gameView').style.display='none'; 
            document.getElementById('archiveView').style.display='block';
            loadArchive();
        });
        document.getElementById('btnToGameFromArchive').addEventListener('click', () => {
            document.getElementById('gameView').style.display='block'; 
            document.getElementById('archiveView').style.display='none';
        });
        document.getElementById('btnResetSession').addEventListener('click', () => location.reload());
        document.getElementById('btnResetArchive').addEventListener('click', async () => {
            if(confirm("Svuoto tutto?")) {
                await fetch(URL, { method: 'PUT', headers: {'Content-Type': 'application/json', 'X-Access-Key': KEY}, body: JSON.stringify([]) });
                loadArchive();
            }
        });

        window.onload = initTable;
    </script>
</body>
</html>
