<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Tracker & Strategia</title>
    <link rel="icon" href="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png" type="image/png">
    <style>
        :root {
            --green-dark: #006400;
            --green-light: #90ee90;
            --red: #ff4500;
            --black: #000000;
            --white: #ffffff;
            --gold: #ffd700;
            --gray-light: #f0f0f0;
            --blue-recall: #007bff;
        }

        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: var(--green-dark); color: var(--white); }
        .container { max-width: 1200px; margin: auto; padding: 10px; }
        .header img { max-width: 50%; max-height: 12vh; height: auto; display: block; margin: 0 auto; padding: 5px 0; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 12px; margin: 5px 0 10px; border-radius: 5px; border: 1px solid var(--gold); box-sizing: border-box; font-size: 1.1em; text-align: center; }
        .info-box { background-color: rgba(0, 0, 0, 0.4); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        #saldoRealTimeValue { font-size: 2em; font-weight: bold; display: block; margin-top: 5px; padding: 5px; border-radius: 5px; background-color: var(--white); color: var(--red); text-align: center; }
        #scommessaContainer { text-align: center; background-color: rgba(255, 255, 255, 0.9); color: var(--black); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        #scommessaValue { font-size: 1.2em; font-weight: bold; line-height: 1.5; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background-color: rgba(255, 255, 255, 0.1); }
        th, td { padding: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); font-size: 0.9em; }
        th { background-color: rgba(0, 0, 0, 0.5); color: var(--gold); }
        .highlighted-row { background-color: var(--green-light) !important; color: var(--black); }
        .main-buttons-container { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .main-buttons-row { display: flex; gap: 10px; flex-wrap: wrap; }
        button { flex-grow: 1; padding: 8px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; min-width: 100px; }
        #btnArchivia { background-color: #1e90ff; color: white; }
        #btnResetSession { background-color: #dc3545; color: white; }
        #btnToArchive { background-color: #ffc107; color: black; }
        #btnRecallLast7 { background-color: var(--blue-recall); color: white; }
        #btnToGameFromArchive { background-color: #28a745; color: white; }
        #btnResetArchive { background-color: #6c757d; color: white; }
        .view { display: none; }
        #gameView { display: block; }
        #archiveView { background-color: rgba(0, 0, 0, 0.7); min-height: 100vh; }
        #cassaStoricaContainer { text-align: center; padding: 15px; border-radius: 8px; margin-top: 20px; color: black; }
        #cassaStoricaValue { font-size: 2em; font-weight: bold; display: block; }
    </style>
</head>
<body>

    <div id="gameView" class="view container">
        <div class="header"><img src="https://raw.githubusercontent.com/mauro8274/MANDRAKE/13cdc9b29c08d454e8ac3aee5a65679c15ad97d2/IMG_0648.png"></div>
        <div class="info-box">
            <label>NUOVO NUMERO ESTRATTO (0-36):</label>
            <input type="number" id="numeroEstratto" inputmode="numeric" pattern="[0-9]*" autofocus>
            <label>PUNTATA (1 Fiche â‚¬):</label>
            <input type="number" id="puntataInput" step="0.01" value="0.10">
        </div>
        <div class="info-box"><label>SALDO REAL TIME</label><span id="saldoRealTimeValue">0.00â‚¬</span></div>
        <div class="main-buttons-container">
            <div class="main-buttons-row">
                <button id="btnArchivia">Archivia Sessione</button>
                <button id="btnResetSession">Reset Sessione</button>
                <button id="btnToArchive">Archivio</button>
            </div>
            <button id="btnRecallLast7">Richiama Ultimi 7 Numeri</button>
        </div>
        <div class="info-box">
            <table id="dataAreaTable">
                <thead><tr><th colspan="9">ULTIMI 9 NUMERI</th></tr></thead>
                <tbody id="lastNineNumbersRow"></tbody>
            </table>
        </div>
        <div id="scommessaContainer"><h3>PUNTA SU:</h3><p id="scommessaValue">In attesa di dati...</p></div>
        <div class="info-box">
            <table id="bettingTable">
                <thead><tr><th>STEP</th><th>COLORE</th><th>LINEA</th><th>DOZZINA</th><th>TOT. BET</th><th>NETTO</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="archiveView" class="view container">
        <div class="header"><h1>ðŸ“š Archivio</h1></div>
        <div id="cassaStoricaContainer"><label>CASSA STORICA NETTA</label><span id="cassaStoricaValue">0.00â‚¬</span></div>
        <div class="main-buttons-row" style="margin-top:20px">
            <button id="btnToGameFromArchive">Torna al Gioco</button>
            <button id="btnResetArchive">Reset Archivio</button>
        </div>
        <table id="archiveTable" style="background:white; color:black; margin-top:20px">
            <thead><tr><th>DATA</th><th>ORA</th><th>NETTO</th><th>INV.</th><th>STEP</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

<script>
    const JSON_BIN_ID = '693c2d5343b1c97be9e984aa';
    const API_KEY = '$2a$10$ayP59Hfi7LkT35rikrQPk.p7vm9HN/Cko1Nwr2I0HrZyu0/1BVMLe';
    const ROULETTE_MAP = {
        'RED': [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36],
        'BLACK': [2,4,6,8,10,11,13,15,17,20,22,24,26,28,29,31,33,35],
        'D1': [1,2,3,4,5,6,7,8,9,10,11,12], 'D3': [25,26,27,28,29,30,31,32,33,34,35,36],
        'L2': [2,5,8,11,14,17,20,23,26,29,32,35], 'L3': [3,6,9,12,15,18,21,24,27,30,33,36]
    };

    let session = { extracted: [], step: 0, factors: {}, history: [], saldo: 0 };

    function format(v) { return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(v); }

    function createTable() {
        const tbody = document.querySelector('#bettingTable tbody');
        tbody.innerHTML = ''; session.history = [];
        for (let i = 1; i <= 50; i++) {
            const r = tbody.insertRow(); r.id = `row-${i}`;
            r.innerHTML = `<td>${i}</td><td class="c">0â‚¬</td><td class="l">0â‚¬</td><td class="d">0â‚¬</td><td class="t">0â‚¬</td><td class="n">0â‚¬</td>`;
            session.history.push({ color: 0, line: 0, dozen: 0, total: 0, netto: 0, played: false });
        }
    }

    function calculateFactors() {
        const last9 = session.extracted.slice(-9);
        if (last9.length < 9) return;
        const counts = { RED: 0, BLACK: 0, D1: 0, D3: 0 };
        last9.forEach(n => {
            if (n === 0) return;
            if (ROULETTE_MAP.RED.includes(n)) counts.RED++;
            if (ROULETTE_MAP.BLACK.includes(n)) counts.BLACK++;
            if (ROULETTE_MAP.D1.includes(n)) counts.D1++;
            if (ROULETTE_MAP.D3.includes(n)) counts.D3++;
        });
        session.factors.color = counts.RED <= counts.BLACK ? 'RED' : 'BLACK';
        session.factors.dozen = counts.D1 <= counts.D3 ? 'D1' : 'D3';
        session.factors.line = (session.factors.color === 'RED') ? 'L3' : 'L2';

        const dispColor = session.factors.color === 'RED' ? 'ROSSO' : 'NERO';
        const dispLine = session.factors.line === 'L2' ? 'LINEA 2 (2-35)' : 'LINEA 3 (3-36)';
        const dispDozen = session.factors.dozen === 'D1' ? 'DOZZINA 1 (1-12)' : 'DOZZINA 3 (25-36)';

        document.getElementById('scommessaValue').innerHTML = `<span style="color:${session.factors.color === 'RED'?'red':'black'}">${dispColor}</span><br>${dispLine}<br>${dispDozen}`;
        
        if (session.step === 0) {
            const p = parseFloat(document.getElementById('puntataInput').value);
            alert(`ðŸ”” INIZIO STRATEGIA ðŸ””\n\nPuntata per fattore: ${format(p)}\nTotale Step 1: ${format(p*3)}\n\nFattori:\n- ${dispColor}\n- ${dispLine}\n- ${dispDozen}`);
            setupStep(1, p);
        }
    }

    function setupStep(s, amt) {
        session.step = s;
        const data = session.history[s-1];
        data.color = data.line = data.dozen = amt;
        data.total = amt * 3; data.played = true;
        const r = document.getElementById(`row-${s}`);
        r.classList.add('highlighted-row');
        r.querySelector('.c').textContent = format(amt);
        r.querySelector('.l').textContent = format(amt);
        r.querySelector('.d').textContent = format(amt);
        r.querySelector('.t').textContent = format(data.total);
    }

    function process(n) {
        const data = session.history[session.step-1];
        let win = 0; let hits = 0;
        if (n !== 0) {
            if (ROULETTE_MAP[session.factors.color].includes(n)) { win += data.color * 2; hits++; }
            if (ROULETTE_MAP[session.factors.line].includes(n)) { win += data.line * 3; hits++; }
            if (ROULETTE_MAP[session.factors.dozen].includes(n)) { win += data.dozen * 3; hits++; }
        }
        data.netto = win - data.total;
        session.saldo = parseFloat((session.saldo + data.netto).toFixed(2));
        
        const r = document.getElementById(`row-${session.step}`);
        const nc = r.querySelector('.n');
        nc.textContent = format(data.netto); nc.style.color = data.netto >= 0 ? 'green' : 'red';
        
        const sv = document.getElementById('saldoRealTimeValue');
        sv.textContent = format(session.saldo); sv.style.color = session.saldo >= 0 ? 'green' : 'red';

        if (session.saldo > 0) {
            alert(`ðŸŽ‰ SESSIONE VINCENTE!\n\nSaldo Finale: ${format(session.saldo)}\nStep raggiunti: ${session.step}\n\nArchivia per salvare i progressi.`);
        } else if (session.step < 50) {
            const p = parseFloat(document.getElementById('puntataInput').value);
            setupStep(session.step + 1, hits === 0 ? data.color + p : data.color);
            r.classList.remove('highlighted-row');
        }
    }

    document.getElementById('numeroEstratto').addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            const n = parseInt(e.target.value);
            if (isNaN(n) || n < 0 || n > 36) return;
            session.extracted.push(n); e.target.value = '';
            updateNumbers();
            if (session.extracted.length >= 9) {
                if (session.step === 0) calculateFactors(); else process(n);
            }
        }
    });

    function updateNumbers() {
        const row = document.getElementById('lastNineNumbersRow'); row.innerHTML = '';
        session.extracted.slice(-9).forEach(n => {
            const c = document.createElement('td'); c.textContent = n;
            if (n === 0) c.style.background = 'var(--green-light)';
            else if (ROULETTE_MAP.RED.includes(n)) { c.style.background = 'red'; c.style.color = 'white'; }
            else { c.style.background = 'black'; c.style.color = 'white'; }
            row.appendChild(c);
        });
    }

    async function loadArchive() {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSON_BIN_ID}/latest`, { headers: { 'X-ACCESS-KEY': API_KEY }});
        const d = await res.json();
        const list = Array.isArray(d.record) ? d.record : [];
        const tbody = document.querySelector('#archiveTable tbody');
        tbody.innerHTML = ''; let total = 0;
        list.slice().reverse().forEach(s => {
            total += s.netto;
            const r = tbody.insertRow();
            r.innerHTML = `<td>${s.data}</td><td>${s.ora}</td><td style="color:${s.netto>=0?'green':'red'}">${format(s.netto)}</td><td>${format(s.inv)}</td><td>${s.step}</td>`;
        });
        const cVal = document.getElementById('cassaStoricaValue');
        cVal.textContent = format(total);
        document.getElementById('cassaStoricaContainer').style.backgroundColor = total >= 0 ? 'var(--gold)' : 'var(--red)';
    }

    document.getElementById('btnArchivia').addEventListener('click', async () => {
        if (session.step === 0) return;
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSON_BIN_ID}/latest`, { headers: { 'X-ACCESS-KEY': API_KEY }});
        const d = await res.json();
        let list = Array.isArray(d.record) ? d.record : [];
        const now = new Date();
        list.push({ data: now.toLocaleDateString(), ora: now.toLocaleTimeString(), netto: session.saldo, inv: parseFloat(document.getElementById('puntataInput').value), step: session.step });
        await fetch(`https://api.jsonbin.io/v3/b/${JSON_BIN_ID}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-ACCESS-KEY': API_KEY }, body: JSON.stringify(list) });
        alert("Sessione salvata correttamente!"); location.reload();
    });

    document.getElementById('btnToArchive').addEventListener('click', () => { document.getElementById('gameView').style.display='none'; document.getElementById('archiveView').style.display='block'; loadArchive(); });
    document.getElementById('btnToGameFromArchive').addEventListener('click', () => { document.getElementById('gameView').style.display='block'; document.getElementById('archiveView').style.display='none'; });
    document.getElementById('btnResetSession').addEventListener('click', () => location.reload());
    document.getElementById('btnResetArchive').addEventListener('click', async () => { if(confirm("Resettare tutto?")) { await fetch(`https://api.jsonbin.io/v3/b/${JSON_BIN_ID}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-ACCESS-KEY': API_KEY }, body: JSON.stringify([]) }); loadArchive(); }});

    window.onload = createTable;
</script>
</body>
</html>
